<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แดชบอร์ด - ระบบจัดการสถานที่ท่องเที่ยวเชียงใหม่</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts - Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard">
                <i class="fas fa-map-marked-alt me-2"></i>
                เชียงใหม่ Admin
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>
                            แดชบอร์ด
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/places">
                            <i class="fas fa-map-marker-alt me-1"></i>
                            จัดการสถานที่
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/categories">
                            <i class="fas fa-tags me-1"></i>
                            จัดการหมวดหมู่
                        </a>
                    </li>
                </ul>
                
                <!-- User Info and Logout -->
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="username-display">ผู้ดูแลระบบ</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <span class="dropdown-item-text">
                                    <small class="text-muted">เข้าสู่ระบบล่าสุด:</small><br>
                                    <span id="last-login-display">-</span>
                                </span>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-1"></i>
                                    ออกจากระบบ
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3 mb-0">แดชบอร์ด</h1>
                <p class="text-muted">ภาพรวมระบบจัดการสถานที่ท่องเที่ยวเชียงใหม่</p>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <!-- Total Places -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-primary shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    สถานที่ทั้งหมด
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-places">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-map-marker-alt fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Categories -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-success shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    หมวดหมู่ทั้งหมด
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-categories">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tags fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Published Places -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-info shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    สถานที่ที่เผยแพร่
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="published-places">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-eye fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Places -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card border-left-warning shadow h-100 py-2">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                    สถานที่ใหม่ (7 วัน)
                                </div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800" id="recent-places">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-plus-circle fa-2x text-gray-300"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row mb-4">
            <div class="col">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">การดำเนินการด่วน</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <a href="/places/new" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-plus me-2"></i>
                                    เพิ่มสถานที่ใหม่
                                </a>
                            </div>
                            <div class="col-md-4 mb-3">
                                <a href="/places" class="btn btn-outline-primary btn-lg w-100">
                                    <i class="fas fa-list me-2"></i>
                                    ดูรายการสถานที่
                                </a>
                            </div>
                            <div class="col-md-4 mb-3">
                                <a href="/categories" class="btn btn-outline-success btn-lg w-100">
                                    <i class="fas fa-tags me-2"></i>
                                    จัดการหมวดหมู่
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Categories Overview -->
        <div class="row">
            <div class="col-lg-8 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">ภาพรวมหมวดหมู่</h6>
                    </div>
                    <div class="card-body">
                        <div id="categories-overview">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="text-muted mt-2">กำลังโหลดข้อมูล...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="col-lg-4 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">กิจกรรมล่าสุด</h6>
                    </div>
                    <div class="card-body">
                        <div id="recent-activity">
                            <div class="text-center py-4">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="text-muted mt-2">กำลังโหลดข้อมูล...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="/js/admin.js"></script>
    
    <!-- Dashboard specific JS -->
    <script>
        // Dashboard initialization
        document.addEventListener('DOMContentLoaded', function() {
            initDashboard();
        });

        function initDashboard() {
            loadDashboardData();
            loadUserInfo();
        }

        function loadDashboardData() {
            // Load statistics
            fetch('/api/dashboard/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateStatistics(data.stats);
                        updateCategoriesOverview(data.categories);
                        updateRecentActivity(data.recentActivity);
                    } else {
                        console.error('Failed to load dashboard data:', data.message);
                        showErrorInStats();
                    }
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showErrorInStats();
                });
        }

        function loadUserInfo() {
            fetch('/api/user/info')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('username-display').textContent = data.user.username;
                        if (data.user.lastLogin) {
                            const lastLogin = new Date(data.user.lastLogin);
                            document.getElementById('last-login-display').textContent = 
                                lastLogin.toLocaleString('th-TH');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading user info:', error);
                });
        }

        function updateStatistics(stats) {
            document.getElementById('total-places').textContent = stats.totalPlaces || 0;
            document.getElementById('total-categories').textContent = stats.totalCategories || 0;
            document.getElementById('published-places').textContent = stats.publishedPlaces || 0;
            document.getElementById('recent-places').textContent = stats.recentPlaces || 0;
        }

        function updateCategoriesOverview(categories) {
            const container = document.getElementById('categories-overview');
            
            if (!categories || categories.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-tags fa-2x text-muted"></i>
                        <p class="text-muted mt-2">ยังไม่มีหมวดหมู่</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="row">';
            categories.forEach(category => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-${category.icon || 'tag'} fa-2x text-primary"></i>
                            </div>
                            <div>
                                <h6 class="mb-0">${category.name.th}</h6>
                                <small class="text-muted">${category.placesCount || 0} สถานที่</small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function updateRecentActivity(activities) {
            const container = document.getElementById('recent-activity');
            
            if (!activities || activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clock fa-2x text-muted"></i>
                        <p class="text-muted mt-2">ยังไม่มีกิจกรรม</p>
                    </div>
                `;
                return;
            }

            let html = '';
            activities.forEach(activity => {
                const date = new Date(activity.date);
                html += `
                    <div class="d-flex align-items-center mb-3">
                        <div class="me-3">
                            <i class="fas fa-${activity.icon || 'circle'} text-${activity.type || 'primary'}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="small">${activity.message}</div>
                            <div class="text-muted small">${date.toLocaleString('th-TH')}</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showErrorInStats() {
            document.getElementById('total-places').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
            document.getElementById('total-categories').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
            document.getElementById('published-places').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
            document.getElementById('recent-places').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i>';
        }

        function logout() {
            if (confirm('คุณต้องการออกจากระบบหรือไม่?')) {
                window.location.href = '/auth/logout';
            }
        }
    </script>
</body>
</html>