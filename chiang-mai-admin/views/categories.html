<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</title>

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Google Fonts - Sarabun -->
    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/admin.css" />
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="/dashboard">
          <i class="fas fa-map-marked-alt me-2"></i>
          ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà Admin
        </a>

        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="/dashboard">
                <i class="fas fa-tachometer-alt me-1"></i>
                ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/places">
                <i class="fas fa-map-marker-alt me-1"></i>
                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/categories">
                <i class="fas fa-tags me-1"></i>
                ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà
              </a>
            </li>
          </ul>

          <!-- User Info and Logout -->
          <ul class="navbar-nav">
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                id="userDropdown"
                role="button"
                data-bs-toggle="dropdown"
              >
                <i class="fas fa-user-circle me-1"></i>
                <span id="username-display">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <span class="dropdown-item-text">
                    <small class="text-muted">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</small><br />
                    <span id="last-login-display">-</span>
                  </span>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                  </a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid py-4">
      <!-- Page Header -->
      <div class="row mb-4">
        <div class="col-md-8">
          <h1 class="h3 mb-0">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h1>
          <p class="text-muted">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß</p>
        </div>
        <div class="col-md-4 text-end">
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#categoryModal"
            onclick="openAddCategoryModal()"
          >
            <i class="fas fa-plus me-2"></i>
            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      </div>

      <!-- Alert Messages -->
      <div id="alert-container"></div>

      <!-- Categories List -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow">
            <div class="card-header py-3">
              <h6 class="m-0 font-weight-bold text-primary">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h6>
            </div>
            <div class="card-body">
              <div id="categories-loading" class="text-center py-4">
                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                <p class="text-muted mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
              </div>

              <div id="categories-table" style="display: none">
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead class="table-light">
                      <tr>
                        <th width="60">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                        <th width="80">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                        <th width="120">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th width="150">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á</th>
                        <th width="120">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                      </tr>
                    </thead>
                    <tbody id="categories-tbody">
                      <!-- Categories will be loaded here -->
                    </tbody>
                  </table>
                </div>
              </div>

              <div id="categories-empty" style="display: none">
                <div class="text-center py-5">
                  <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h5>
                  <p class="text-muted">
                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                  </p>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#categoryModal"
                    onclick="openAddCategoryModal()"
                  >
                    <i class="fas fa-plus me-2"></i>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Modal -->
    <div
      class="modal fade"
      id="categoryModal"
      tabindex="-1"
      aria-labelledby="categoryModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="categoryModalLabel">
              ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form id="categoryForm">
            <div class="modal-body">
              <input type="hidden" id="categoryId" name="id" />

              <!-- Icon Selection -->
              <div class="mb-3">
                <label for="categoryIcon" class="form-label"
                  >‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô <span class="text-danger">*</span></label
                >
                <div class="row">
                  <div class="col-md-8">
                    <select
                      class="form-select"
                      id="categoryIcon"
                      name="icon"
                      required
                    >
                      <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</option>
                      <option value="utensils">üç¥ ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ (utensils)</option>
                      <option value="bed">üõèÔ∏è ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å (bed)</option>
                      <option value="camera">
                        üì∑ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß (camera)
                      </option>
                      <option value="play">‚ñ∂Ô∏è ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (play)</option>
                      <option value="shopping-cart">
                        üõí ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á (shopping-cart)
                      </option>
                      <option value="spa">üßò ‡∏™‡∏õ‡∏≤ (spa)</option>
                      <option value="car">üöó ‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (car)</option>
                      <option value="music">üéµ ‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á (music)</option>
                      <option value="graduation-cap">
                        üéì ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ (graduation-cap)
                      </option>
                      <option value="heart">‚ù§Ô∏è ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û (heart)</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <div class="text-center p-2 border rounded">
                      <i
                        id="iconPreview"
                        class="fas fa-question fa-2x text-muted"
                      ></i>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Language Tabs -->
              <div class="mb-3">
                <label class="form-label"
                  >‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà <span class="text-danger">*</span></label
                >
                <ul class="nav nav-tabs" id="languageTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link active"
                      id="th-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#th-content"
                      type="button"
                      role="tab"
                    >
                      ‡πÑ‡∏ó‡∏¢ <span class="text-danger">*</span>
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="en-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#en-content"
                      type="button"
                      role="tab"
                    >
                      English
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="zh-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#zh-content"
                      type="button"
                      role="tab"
                    >
                      ‰∏≠Êñá
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button
                      class="nav-link"
                      id="ja-tab"
                      data-bs-toggle="tab"
                      data-bs-target="#ja-content"
                      type="button"
                      role="tab"
                    >
                      Êó•Êú¨Ë™û
                    </button>
                  </li>
                </ul>

                <div
                  class="tab-content border border-top-0 p-3"
                  id="languageTabContent"
                >
                  <div
                    class="tab-pane fade show active"
                    id="th-content"
                    role="tabpanel"
                  >
                    <input
                      type="text"
                      class="form-control"
                      id="nameTh"
                      name="name_th"
                      placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢"
                      required
                    />
                  </div>
                  <div class="tab-pane fade" id="en-content" role="tabpanel">
                    <input
                      type="text"
                      class="form-control"
                      id="nameEn"
                      name="name_en"
                      placeholder="Category name in English"
                    />
                  </div>
                  <div class="tab-pane fade" id="zh-content" role="tabpanel">
                    <input
                      type="text"
                      class="form-control"
                      id="nameZh"
                      name="name_zh"
                      placeholder="‰∏≠ÊñáÁ±ªÂà´ÂêçÁß∞"
                    />
                  </div>
                  <div class="tab-pane fade" id="ja-content" role="tabpanel">
                    <input
                      type="text"
                      class="form-control"
                      id="nameJa"
                      name="name_ja"
                      placeholder="Êó•Êú¨Ë™û„ÅÆ„Ç´„ÉÜ„Ç¥„É™Âêç"
                    />
                  </div>
                </div>
              </div>

              <!-- Order -->
              <div class="mb-3">
                <label for="categoryOrder" class="form-label"
                  >‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="categoryOrder"
                  name="order"
                  min="1"
                  placeholder="‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á (‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô)"
                />
                <div class="form-text">
                  ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
              </button>
              <button
                type="submit"
                class="btn btn-primary"
                id="saveCategoryBtn"
              >
                <i class="fas fa-save me-2"></i>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Custom JS -->
    <script src="/js/admin.js"></script>

    <!-- Categories specific JS -->
    <script>
      let categories = [];
      let editingCategoryId = null;

      // Initialize page
      document.addEventListener("DOMContentLoaded", function () {
        loadCategories();
        loadUserInfo();
        initializeEventListeners();
      });

      function initializeEventListeners() {
        // Icon preview
        document
          .getElementById("categoryIcon")
          .addEventListener("change", function () {
            const iconPreview = document.getElementById("iconPreview");
            if (this.value) {
              iconPreview.className = `fas fa-${this.value} fa-2x text-primary`;
            } else {
              iconPreview.className = "fas fa-question fa-2x text-muted";
            }
          });

        // Form submission
        document
          .getElementById("categoryForm")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            saveCategory();
          });
      }

      function loadCategories() {
        fetch("/api/categories")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              categories = data.categories;
              renderCategories();
            } else {
              showAlert(
                "error",
                "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà: " + data.message
              );
              showEmptyState();
            }
          })
          .catch((error) => {
            console.error("Error loading categories:", error);
            showAlert("error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå");
            showEmptyState();
          })
          .finally(() => {
            document.getElementById("categories-loading").style.display =
              "none";
          });
      }

      function renderCategories() {
        const tbody = document.getElementById("categories-tbody");

        if (categories.length === 0) {
          showEmptyState();
          return;
        }

        // Sort categories by order
        const sortedCategories = [...categories].sort(
          (a, b) => (a.order || 999) - (b.order || 999)
        );

        let html = "";
        sortedCategories.forEach((category, index) => {
          const createdDate = new Date(category.createdAt).toLocaleDateString(
            "th-TH"
          );
          html += `
                    <tr>
                        <td class="text-center">${
                          category.order || index + 1
                        }</td>
                        <td class="text-center">
                            <i class="fas fa-${
                              category.icon || "tag"
                            } fa-lg text-primary"></i>
                        </td>
                        <td>
                            <strong>${category.name.th}</strong>
                            ${
                              category.name.en
                                ? `<br><small class="text-muted">${category.name.en}</small>`
                                : ""
                            }
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">${
                              category.placesCount || 0
                            }</span>
                        </td>
                        <td class="text-center">
                            <small>${createdDate}</small>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary" onclick="editCategory('${
                                  category.id
                                }')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="deleteCategory('${
                                  category.id
                                }', '${category.name.th}')" title="‡∏•‡∏ö">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
        });

        tbody.innerHTML = html;
        document.getElementById("categories-table").style.display = "block";
        document.getElementById("categories-empty").style.display = "none";
      }

      function showEmptyState() {
        document.getElementById("categories-table").style.display = "none";
        document.getElementById("categories-empty").style.display = "block";
      }

      function openAddCategoryModal() {
        editingCategoryId = null;
        document.getElementById("categoryModalLabel").textContent =
          "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà";
        document.getElementById("saveCategoryBtn").innerHTML =
          '<i class="fas fa-save me-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

        // Reset form
        document.getElementById("categoryForm").reset();
        document.getElementById("iconPreview").className =
          "fas fa-question fa-2x text-muted";

        // Switch to Thai tab
        document.getElementById("th-tab").click();
      }

      function editCategory(categoryId) {
        const category = categories.find((c) => c.id === categoryId);
        if (!category) return;

        editingCategoryId = categoryId;
        document.getElementById("categoryModalLabel").textContent =
          "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà";
        document.getElementById("saveCategoryBtn").innerHTML =
          '<i class="fas fa-save me-2"></i>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';

        // Fill form with category data
        document.getElementById("categoryId").value = category.id;
        document.getElementById("categoryIcon").value = category.icon || "";
        document.getElementById("nameTh").value = category.name.th || "";
        document.getElementById("nameEn").value = category.name.en || "";
        document.getElementById("nameZh").value = category.name.zh || "";
        document.getElementById("nameJa").value = category.name.ja || "";
        document.getElementById("categoryOrder").value = category.order || "";

        // Update icon preview
        const iconPreview = document.getElementById("iconPreview");
        if (category.icon) {
          iconPreview.className = `fas fa-${category.icon} fa-2x text-primary`;
        } else {
          iconPreview.className = "fas fa-question fa-2x text-muted";
        }

        // Show modal
        const modal = new bootstrap.Modal(
          document.getElementById("categoryModal")
        );
        modal.show();
      }

      function saveCategory() {
        const formData = new FormData(document.getElementById("categoryForm"));
        const categoryData = {
          icon: formData.get("icon"),
          name: {
            th: formData.get("name_th"),
            en: formData.get("name_en") || "",
            zh: formData.get("name_zh") || "",
            ja: formData.get("name_ja") || "",
          },
          order: parseInt(formData.get("order")) || null,
        };

        // Validation
        if (!categoryData.name.th.trim()) {
          showAlert("error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢");
          return;
        }

        if (!categoryData.icon) {
          showAlert("error", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô");
          return;
        }

        const url = editingCategoryId
          ? `/api/categories/${editingCategoryId}`
          : "/api/categories";
        const method = editingCategoryId ? "PUT" : "POST";

        if (editingCategoryId) {
          categoryData.id = editingCategoryId;
        }

        fetch(url, {
          method: method,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(categoryData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showAlert(
                "success",
                editingCategoryId
                  ? "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
                  : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß"
              );

              // Close modal
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("categoryModal")
              );
              modal.hide();

              // Reload categories
              loadCategories();
            } else {
              showAlert("error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error saving category:", error);
            showAlert("error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
          });
      }

      // Delete category function is now handled by admin.js
      // This function is kept for compatibility but will delegate to the global function
      function deleteCategory(categoryId, categoryName) {
        // The deleteCategory function is now implemented in admin.js with proper confirmation dialog
        if (
          window.deleteCategory &&
          typeof window.deleteCategory === "function"
        ) {
          window.deleteCategory(categoryId, categoryName);
        } else {
          // Fallback to simple confirm if admin.js is not loaded
          const category = categories.find((c) => c.id === categoryId);
          const placesCount = category ? category.placesCount || 0 : 0;

          let confirmMessage = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà "${categoryName}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
          if (placesCount > 0) {
            confirmMessage += `\n\n‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ${placesCount} ‡πÅ‡∏´‡πà‡∏á ‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏ú‡∏•‡∏ï‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ`;
          }

          if (confirm(confirmMessage)) {
            fetch(`/api/categories/${categoryId}`, {
              method: "DELETE",
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.success) {
                  showAlert("success", "‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
                  loadCategories();
                } else {
                  showAlert("error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + data.message);
                }
              })
              .catch((error) => {
                console.error("Error deleting category:", error);
                showAlert("error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
              });
          }
        }
      }

      function loadUserInfo() {
        fetch("/api/user/info")
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              document.getElementById("username-display").textContent =
                data.user.username;
              if (data.user.lastLogin) {
                const lastLogin = new Date(data.user.lastLogin);
                document.getElementById("last-login-display").textContent =
                  lastLogin.toLocaleString("th-TH");
              }
            }
          })
          .catch((error) => {
            console.error("Error loading user info:", error);
          });
      }

      function showAlert(type, message) {
        const alertContainer = document.getElementById("alert-container");
        const alertClass =
          type === "success" ? "alert-success" : "alert-danger";
        const iconClass =
          type === "success" ? "fa-check-circle" : "fa-exclamation-triangle";

        const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${iconClass} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;

        alertContainer.innerHTML = alertHtml;

        // Auto dismiss after 5 seconds
        setTimeout(() => {
          const alert = alertContainer.querySelector(".alert");
          if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          }
        }, 5000);
      }

      function logout() {
        if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
          window.location.href = "/auth/logout";
        }
      }
    </script>
  </body>
</html>
